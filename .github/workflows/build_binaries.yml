name: Add binaries to release
'on':
  release:
    types:
      - published
jobs:
  build_frontend_for_release:
    name: Add frontend binaries to release
    runs-on: ubuntu-latest
    environment:
      name: main
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
    - name: Build frontend
      working-directory: frontend
      run: >
        npm ci
        npm run build
        cd ..
        if [ -d frontend/dist ]; then zip -r frontend-dist.zip
        frontend/dist; else echo "no dist folder"; fi  
    - name: Upload frontend zip to release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./frontend-dist.zip
        asset_name: frontend-dist.zip
        asset_content_type: application/zip
      env:
        GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        
  build_backend_for_release:
    name: Add backend binaries to release
    runs-on: ubuntu-latest
    environment:
      name: main
    permissions:
       packages: write
       contents: read
       attestations: write
       id-token: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '21'
    - name: Cache Maven local repository
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: '${{ runner.os }}-m2-${{ hashFiles(''**/pom.xml'') }}'
    - name: Build backend (Maven)
      working-directory: backend
      run: mvn -B -DskipTests package
    - name: Archive backend JAR
      run: |
        mkdir -p build-artifacts
        ls -la backend/target
        cp backend/target/*.jar build-artifacts/ || true
        ls -la build-artifacts     
    - name: Upload backend JAR to release
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./backend/target/*.jar
        asset_name: backend.jar
        asset_content_type: application/java-archive
      env:
        GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
